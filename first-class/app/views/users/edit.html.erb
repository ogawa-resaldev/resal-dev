<div class="mt-7 bg-white border border-gray-200 rounded-xl shadow-sm dark:bg-gray-800 dark:border-gray-700">
  <div class="p-4 sm:p-7">
    <div class="text-center">
      <h1 class="block text-2xl font-bold text-gray-800 dark:text-white">ユーザー情報</h1>
    </div>

    <div class="mt-5">
      <!-- Form -->
      <%= form_with model: @user, url: {action: 'update'} do |f| %>
        <%= render 'shared/error_messages', object: f.object %>
          <div class="grid gap-y-4">
            <!-- Form Group -->
            <div>
              <label class="block text-sm mb-2 dark:text-white">ユーザー名</label>
              <div class="relative">
                <%= f.text_field :name, class:"py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-700 dark:text-gray-400 dark:focus:ring-gray-600" %>
                <div class="hidden absolute inset-y-0 end-0 pointer-events-none pe-3">
                  <svg class="size-5 text-red-500" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                  </svg>
                </div>
              </div>
            </div>
            <!-- End Form Group -->

            <!-- Form Group -->
            <div>
              <label class="block text-sm mb-2 dark:text-white">ログインID</label>
              <div class="relative">
                <p class="py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" readonly="readonly">
                  <%= @user.login_id %>
                </p>
                <div class="hidden absolute inset-y-0 end-0 pointer-events-none pe-3">
                  <svg class="size-5 text-red-500" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                  </svg>
                </div>
              </div>
            </div>
            <!-- End Form Group -->

            <!-- Form Group -->
            <div>
              <div class="flex justify-between items-center">
                <label class="block text-sm mb-2 dark:text-white">パスワード ※更新時のみ入力</label>
              </div>
              <div class="relative">
                <%= f.password_field :password_digest, class:"py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-700 dark:text-gray-400 dark:focus:ring-gray-600" %>
                <div class="hidden absolute inset-y-0 end-0 pointer-events-none pe-3">
                  <svg class="size-5 text-red-500" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                  </svg>
                </div>
              </div>
            </div>
            <!-- End Form Group -->

            <!-- Form Group -->
            <div>
              <label class="block text-sm mb-2 dark:text-white">ユーザーロール</label>
              <div class="relative">
                <p class="py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" readonly="readonly">
                  <%= @user.user_role.name %>
                </p>
                <div class="hidden absolute inset-y-0 end-0 pointer-events-none pe-3">
                  <svg class="size-5 text-red-500" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                  </svg>
                </div>
              </div>
            </div>
            <!-- End Form Group -->

            <!-- Form Group -->
            <% if @user.user_role_id == 1 %>
              <%= f.fields_for :user_therapist_setting do |therapist_setting| %>
                <div class="flex flex-col">
                  <label class="block text-sm mb-2 dark:text-white">メールアドレス</label>
                  <%= therapist_setting.text_field :mail_address, class: "py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" %>
                </div>
                <div class="flex flex-col">
                  <label class="block text-sm mb-2 dark:text-white">口座情報</label>
                  <%= therapist_setting.text_area :account_information, class: "py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600", rows: 5 %>
                </div>

                <% if session[:user_role_id] != 1 %>
                  <div class="flex flex-col">
                    <label class="block text-sm mb-2 dark:text-white">キャスト情報</label>
                    <div class="table border-collapse table-auto w-full divide-y divide-gray-200 dark:divide-neutral-700">
                      <div class="table-header-group">
                        <div class="table-row">
                          <div class="table-cell px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">新人</div>
                          <div class="table-cell px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">キャストバック率(%)</div>
                        </div>
                      </div>
                      <div id="user_therapist_setting" class="table-row-group divide-y divide-gray-200 bg-white dark:divide-neutral-700 dark:bg-neutral-800">
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200">
                          <%= therapist_setting.check_box :new_face, {}, "1", "0" %>
                        </div>
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200">
                          <%= therapist_setting.text_field :therapist_back_ratio, class: "py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" %>
                        </div>
                      </div>
                    </div>
                    <label class="block text-sm mb-2 dark:text-white">ホームページキャストの紐付け</label>
                    <div class="table border-collapse table-auto w-full divide-y divide-gray-200 dark:divide-neutral-700">
                      <div class="table-header-group">
                        <div class="table-row">
                          <div class="table-cell px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500 hidden">店舗</div>
                          <div class="table-cell px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500">キャスト</div>
                          <div class="table-cell px-6 py-3 text-start text-xs font-medium text-gray-500 uppercase dark:text-neutral-500 hidden">通知グループID</div>
                        </div>
                      </div>
                      <div class="table-row-group divide-y divide-gray-200 bg-white dark:divide-neutral-700 dark:bg-neutral-800">
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200 hidden">
                          <select id="store_default" class="py-3 px-4 pe-9 block border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" >
                            <% @store_selects.each do |store_select| %>
                              <option data-therapists="<%= store_select[2] %>" value=<%= store_select[1] %>>
                                <%= store_select[0] %>
                              </option>
                            <% end %>
                          </select>
                        </div>
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200">
                          <select id="store_therapist_default" class="py-3 px-4 pe-9 block border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" >
                            <% @store_therapist_initial_select.each do |store_therapist_initial_select| %>
                              <option value=<%= store_therapist_initial_select[1] %>>
                                <%= store_therapist_initial_select[0] %>
                              </option>
                            <% end %>
                          </select>
                        </div>
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200 hidden">
                          <input type="text" id="notification_group_id_default" class="py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" autocomplete="off" />
                        </div>
                        <div class="inline-block align-middle">
                          <%= link_to_add_association "word pressキャストを追加", f, :user_therapists, class:'py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none', data: {association_insertion_node: '#user_therapists', association_insertion_method: :append} %>
                        </div>
                      </div>
                      <div class="table-row-group divide-y divide-gray-200 bg-white dark:divide-neutral-700 dark:bg-neutral-800">
                        <div class="table-cell px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-neutral-200">
                        </div>
                      </div>
                      <div id="user_therapists" class="table-row-group divide-y divide-gray-200 bg-white dark:divide-neutral-700 dark:bg-neutral-800">
                        <%= f.fields_for :user_therapists, @user.user_therapists.sort_by(&:store_id) do |therapist| %>
                          <%= render 'user_therapist_fields', f: therapist %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                <% end %>
              <% end %>
            <% elsif @user.user_role_id == 3 && session[:user_role_id] != 1 %>
              <div class="flex flex-col">
                <label class="block text-sm mb-2 dark:text-white">店舗グループ</label>
                <%= f.fields_for :back_office_group do |back_office_group| %>
                  <%= back_office_group.collection_select :store_group_id, StoreGroup.all_by_user(session[:user_id]), :id, :name, {}, {class: "py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600"} %>
                <% end %>
              </div>
            <% end %>
            <button type="submit" onClick="return check('更新しますか？','update-user')" id="update-user" class="w-full py-3 px-4 inline-flex justify-center items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none">変更</button>
          </div>
      <% end %>

      <% if session[:user_role_id] != 1 %>
        <%= form_with model: @user, url: {action: 'inactive'} do |f| %>
          <div>
            <label class="block text-sm mb-2 dark:text-white">ユーザーの非アクティブ化</label>
              <button type="submit" onClick="return check('非アクティブにしますか？','inactive-user')" id="inactive-user" class="py-3 px-4 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-red-500 text-white hover:bg-red-600 disabled:opacity-50 disabled:pointer-events-none">非アクティブにする</button>
              <div class="hidden absolute inset-y-0 end-0 pointer-events-none pe-3">
                <svg class="size-5 text-red-500" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 4a.905.905 0 0 0-.9.995l.35 3.507a.552.552 0 0 0 1.1 0l.35-3.507A.905.905 0 0 0 8 4zm.002 6a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/>
                </svg>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<!-- ログイン案内modalの定義。 -->
<%= form_with(model: @user, url: send_login_information_user_path(@user), method: :patch, local: true) do |form| %>
  <div id="hs-send-login-information-modal" class="hs-overlay hidden size-full fixed top-0 start-0 z-[80] overflow-x-hidden overflow-y-auto pointer-events-none">
    <div class="hs-overlay-open:mt-7 hs-overlay-open:opacity-100 hs-overlay-open:duration-500 mt-0 opacity-0 ease-out transition-all sm:max-w-lg sm:w-full m-3 sm:mx-auto min-h-[calc(100%-3.5rem)] flex items-center">
      <div class="w-full flex flex-col bg-white border shadow-sm rounded-xl pointer-events-auto dark:bg-gray-800 dark:border-gray-700 dark:shadow-slate-700/[.7] modal-content">
        <div id="modal-errors" class="flex">
          <div class="ms-4">
            <div class="mt-2 text-sm text-red-700 dark:text-red-400">
              <ul id="modal-error-messages" class="list-disc space-y-1 ps-5">
              </ul>
            </div>
          </div>
        </div>
        <div id="modal-contents">
          <div class="flex justify-between items-center py-3 px-4 border-b dark:border-gray-700">
            <h3 class="font-bold text-gray-800 dark:text-white">
              ログイン案内
            </h3>
            <%= form.submit "送信", onClick:"return check('ログイン案内を送信しますか？\\n※案内時にパスワードが変更されます。','send-login-information')", id:"send-login-information", class: "py-2 px-3 inline-flex items-center gap-x-2 text-sm font-semibold rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:pointer-events-none" %>
            <button type="button" class="flex justify-center items-center size-7 text-sm font-semibold rounded-full border border-transparent text-gray-800 hover:bg-gray-100 disabled:opacity-50 disabled:pointer-events-none dark:text-white dark:hover:bg-gray-700" data-hs-overlay-close="#hs-send-login-information-modal">
              <span class="sr-only">Close</span>
              <svg class="flex-shrink-0 size-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
          </div>
          <div class="overflow-x-hidden" style="height:70vh;">
            <div class="border-b border-gray-200 dark:border-neutral-700">
              <div class="flex justify-start gap-x-2 py-3 px-4 border-t dark:border-gray-700">
                <div class="p-4 overflow-y-auto">
                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                      店舗グループ
                    </label>
                    <%= form.collection_select :store_group_id, StoreGroup.all, :id, :name, class:"py-3 px-4 block w-full border-gray-200 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-slate-900 dark:border-gray-700 dark:text-gray-400 dark:focus:ring-gray-600" %>
                  </div>
                  <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2">
                      送信先グループID
                      <span class="text-sm text-gray-500 dark:text-gray-400 block mt-1">
                        ※無記入で、デフォルトの送信先に送られます。
                      </span>
                    </label>
                    <%= form.text_field :target_group_id, name: "target_group_id", class: "py-3 px-4 pe-9 rounded-lg text-sm focus:border-blue-500 focus:ring-blue-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-900 dark:border-neutral-700 dark:text-neutral-400 dark:placeholder-neutral-500 dark:focus:ring-neutral-600" %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="flex justify-end items-center gap-x-2 py-3 px-4 border-t dark:border-neutral-700">
            <button type="button" class="py-2 px-3 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:bg-gray-50 disabled:opacity-50 disabled:pointer-events-none dark:bg-neutral-800 dark:border-neutral-700 dark:text-white dark:hover:bg-neutral-700 dark:focus:bg-neutral-700" data-hs-overlay-close="#hs-send-login-information-modal">
              閉じる
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
  // 店舗、セラピストの選択
  storeDefault = document.getElementById("store_default")
  storeTherapistDefault = document.getElementById("store_therapist_default")
  storeDefault.addEventListener('change', function (event) {
    storeTherapistDefault.innerHTML = '';
    JSON.parse(storeDefault.selectedOptions[0].dataset.therapists).forEach(function(option,index){
      var op = document.createElement('option');
      op.text = option[0]
      op.value = option[1]
      storeTherapistDefault.appendChild(op);
    })
  })
  // 店舗セラピスト追加時に、defaultを反映
  userTherapists = document.getElementById("user_therapists")
  notificationGroupIdDefault = document.getElementById("notification_group_id_default")
  userTherapists.addEventListener('cocoon:after-insert', function(e){
    targetNodes = e.srcElement.children[e.srcElement.children.length - 1].children
    targetNodes[0].children[0].value = storeTherapistDefault.selectedOptions[0].value
    targetNodes[0].children[1].innerHTML = storeTherapistDefault.selectedOptions[0].text
  })
</script>